<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Covid-19 Tracker,Online Coronavirus Tracker</title>
  <link rel="shortcut icon" href="images/corona.png" type="image/x-icon">
  <style>
    .arc text {
      font: 14px sans-serif;
      text-anchor: middle;
      fill: #FFF;
    }

    .arc path {
      stroke: #fff;
      stroke-width: 2px;
    }

    .arc path:hover {
      fill-opacity: .75;
    }

    .flex-row {
      display: flex;
    }

    .flex-row #india {
      flex: 1;
    }

    #india>div {
      display: flex;
      align-items: center;
      justify-content: space-evenly;
    }

    .state {
      fill: none;
      stroke: #a9a9a9;
      stroke-width: 1;
    }

    .state:hover {
      fill-opacity: 0.5;
    }

    #tooltip {
      position: absolute;
      text-align: center;
      padding: 20px;
      margin: 10px;
      font: 12px sans-serif;
      background: lightsteelblue;
      border: 1px;
      border-radius: 2px;
      pointer-events: none;
    }

    #tooltip h4 {
      margin: 0;
      font-size: 14px;
    }

    #tooltip {
      background: rgba(0, 0, 0, 0.9);
      border: 1px solid grey;
      border-radius: 5px;
      font-size: 12px;
      width: auto;
      padding: 4px;
      color: white;
      opacity: 0;
    }

    #tooltip table {
      table-layout: fixed;
    }

    #tooltip tr td {
      padding: 0;
      margin: 0;
    }

    #tooltip tr td:nth-child(1) {
      width: 50px;
    }

    #tooltip tr td:nth-child(2) {
      text-align: center;
    }

    /* table,
    th,
    td {
      border: 1px solid grey;
      border-collapse: collapse;
      padding: 5px;
      text-align: center;
    }

    table tr:nth-child(odd) {
      background-color: #f1f1f1;
    }

    table tr:nth-child(even) {
      background-color: #ffffff;
    } */
    table {
      width: 100%;
      table-layout: fixed;
      border-collapse: collapse;
    }

    table tbody {
      display: block;
      width: 100%;
      overflow: auto;
      height: 400px;
    }

    table thead tr {
      display: block;
    }

    table thead,tbody tr {
      background: #000 !important;
      color: #fff;
      border-bottom: 1px solid goldenrod;
    }
    ::-webkit-scrollbar{
      width: 0;
    }

    table th,
    table td {
      padding: 5px;
      text-align: center;
      width: 250px;
      font-weight: bold;
      border-right: 1px solid goldenrod;
    }
    table thead th{
      background-color: #000;
    }
    table tr:nth-child(odd) {
      background-color: #f1f1f1;
    }

    table tr:nth-child(even) {
      background-color: #ffffff;
    }

    @media screen and (max-width: 600px) {
      .flex-row {
        flex-direction: column;
      }
    }
  </style>
</head>

<body>
  <div class="flex-row">
    <svg width="600" height="600"> </svg>
    <div id="india"></div>
    <div id="tooltip"></div>
  </div>
  <table ng-app="myapp" ng-controller="myctrl" ng-cloak>
    <thead>
      <th>Country <input ng-model="s" placeholder="search country.." /></th>
      <th>Cases</th>
      <th>Today Cases</th>
      <th>Deaths</th>
      <th>Deaths Today</th>
      <th>Active</th>
      <th>Recovered</th>
      <th>Last Updated</th>
    </thead>
    <tbody>
      <tr ng-repeat="x in countriesData | filter:s">
        <td>{{x.country}}</td>
        <td>{{x.cases}}</td>
        <td style="color: dodgerblue;">{{x.todayCases}}</td>
        <td style="color: red;">{{x.deaths}}</td>
        <td>{{x.todayDeaths}}</td>
        <td style="color: green;">{{x.recovered}}</td>
        <td>{{x.active}}</td>
        <td>{{x.updated |date:"MMM dd hh:mm:ss"}}</td>
      </tr>
    </tbody>
  </table>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.17/d3.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.9/angular.min.js"></script>
  <script type="text/javascript">
    var svg = d3.select("svg"),
      width = svg.attr("width"),
      height = svg.attr("height"),
      radius = Math.min(width, height) / 2,
      g = svg.append("g").attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");
    fetch("https://corona.lmao.ninja/all").then(d => d.json()).then(data => {
      drawPie(data || []);
    }).catch(e => console.log(e));

    window.addEventListener("resize", function () {
      width = document.body.clientWidth;
      height = document.body.clientHeight;
      console.log("W " + width + " , " + "H " + height);
      svg
        .attr("width", '100%')
        .attr("height", height / 1.5 + "px")
        .attr('viewBox', '0 0 ' + height + ' ' + width)
        .attr('preserveAspectRatio', 'xMinYMin')
        .append("g")
        .attr("transform", "translate(" + height + "," + width + ")");
    });


    function drawPie(dataArray) {
      delete dataArray.updated;
      var color = d3.scale.ordinal().range(['#ff7f00', '#da3125', '#4daf4a', 'dodgerblue']);
      // Generate the pie
      var pie = d3.layout.pie()
        .value(function (d) { return d; });

      var tooltip = d3.select("body")
        .append("div")
        .style("position", "absolute")
        .style("z-index", "10")
        .style("visibility", "hidden")
        .style("border", "1px solid white")
        .style("border-radius", "4px")
        .style("color", "#FFF")
        .style("padding", "8px")
        .style("text-transform", "uppercase")
        .style("font-weight", "bold");

      // Generate the arcs
      var path = d3.svg.arc()
        .outerRadius(radius - 10)
        .innerRadius(0);

      var label = d3.svg.arc()
        .outerRadius(radius)
        .innerRadius(radius - 80);

      var arc = g.selectAll(".arc")
        .data(pie(Object.values(dataArray)))
        .enter().append("g")
        .attr("class", "arc");

      arc.append("path")
        .attr("d", path)
        .attr("fill", function (d) { return color(d.data); })
        .on("mouseover", function (d, i) { d3.select(this).style("transform", "scale(1.025)"); d3.select(this).style("transition", "all .5s ease-in-out"); tooltip.style("background", color(d.data)); tooltip.text(Object.keys(dataArray)[i]); return tooltip.style("visibility", "visible"); })
        .on("mousemove", function () { return tooltip.style("top", (d3.event.pageY - 10) + "px").style("left", (d3.event.pageX + 10) + "px"); })
        .on("mouseout", function () { d3.select(this).style("transform", "none"); return tooltip.style("visibility", "hidden"); })
        .transition()
        .ease("linear")
        .duration(1000)
        .delay(function (d, i) {
          return i * 25;
        })
        // .attrTween("d", arcTween);
        .attrTween("d", function (d) {
          var i = d3.interpolate({ startAngle: 0, endAngle: 0 }, d);
          return function (t) {
            arc = d3.svg.arc()
              .outerRadius(300 - 10) //<-- create arc
              .innerRadius(0); //<-- return arc path
            return arc(i(t));
          }
        });

      arc.append("text")
        .attr("transform", function (d) {
          return "translate(" + label.centroid(d) + ")";
        })
        .text(function (d) {
          return d.data;
        });
    }



    function tooltipHtml(n, id, d) { /* function to create html content string in tooltip div. */
      return "<h4>" + id + "</h4>" +
        "<h4>" + n + "</h4>";
    }

    function getRandomColor() {
      var letters = '0123456789ABCDEF';
      var color = '#';
      for (var i = 0; i < 6; i++) {
        color += letters[Math.floor(Math.random() * 16)];
      }
      return color;
    }
    var sampleData = {}; /* Sample random data. */
    ["AP", "AR", "AS", "BR", "CT", "DL", "GA", "GJ", "HR", "HP", "JK", "JH", "KA", "KL", "MP", "MH", "MN", "ML", "MZ", "NL", "OR", "PB", "RJ", "SK", "TN", "TR", "UP", "UT", "WB"]
      .forEach(function (d) {
        var low = Math.round(100 * Math.random());
        sampleData[d] = { color: getRandomColor() };
      });

    /* draw states on id #statesvg */
    //iStates.draw("#statesvg", sampleData, tooltipHtml);

    d3.select(self.frameElement).style("height", "600px");

    d3.json("https://api.myjson.com/bins/l36bq", function (json) {
      var projection = d3.geo.mercator()
        .scale(1)
        .translate([0, 0]);

      var path = d3.geo.path()
        .projection(projection);

      function mouseOver(d) {

        d3.select("#tooltip").transition().duration(200).style("opacity", .9);
        d3.select("#tooltip").html(tooltipHtml(d.n, d.id, sampleData[d.id]))
          .style("left", (d3.event.layerX) + "px")
          .style("top", (d3.event.layerY) + "px");
      }

      function mouseOut() {

        d3.select("#tooltip").transition().duration(500).style("opacity", 0);
      }

      function Click(d) {
        delete d.d
        console.log(d)
      }

      var svg = d3.select("#india")
        .append("svg")
        .attr("width", "100%")
        .attr("height", window.innerWidth < 600 ? document.body.clientHeight : "100%")
        .append("g");


      var eS = svg.selectAll(".state")
        .data(json)
        .enter()
        .append("g");

      eS.append("path")
        .attr("class", "state")
        .attr("d", function (d) {
          return d.d;
        })
        .style("fill", function (d) {
          return sampleData[d.id].color;
        })
        .on("mousemove", mouseOver).on("mouseout", mouseOut).on("click", Click)

      eS.append("text")
        .attr("fill", "black")
        .attr("transform", function (d) {
          var bbox = this.previousSibling.getBBox();
          return "translate(" + (bbox.x + bbox.width / 2) + "," + (bbox.y + bbox.height / 2) + ")";
        })
        .attr("text-anchor", "middle")
        .attr("dy", ".35em")
        .text(function (d) {
          return d.id;
        });

      // fetch("https://corona.lmao.ninja/countries/india").then(r => r.json()).then(data => {
      //   d3.select("#india").append("div").append("img").attr("src", data.countryInfo.flag).attr("height", 40);
      //   d3.select("#india div").append("div").html(indiaInfoTable(data.cases, data.todayCases, data.deaths, data.todayDeaths, data.recovered, data.active, data.updated));
      // }).catch(e => console.log(e));
    });

    // function indiaInfoTable(cases, todayCases, deaths, todayDeaths, recovered, active, updated) {
    //   return "<p>Total: " + cases + "</p>" +
    //     "<p>Cases Today: " + todayCases + "</p>" +
    //     "<p>Deaths: " + deaths + "</p>" +
    //     "<p>Deaths Today: " + todayDeaths + "</p>" +
    //     "<p>Recovered: " + recovered + "</p>" +
    //     "<p>Active: " + active + "</p>" +
    //     "<p>Last updated At: " + new Date(updated) + "</p>"
    // }

    var app = angular.module("myapp", []).controller("myctrl", function ($scope, $http) {
      // fetch("https://corona.lmao.ninja/countries/").then(r => r.json()).then(d => {
      //   console.log(d)
      //   $scope.countriesData = d.data || [];
      // }).catch(e => console.log("Error in getting countries data API...."));
      $http.get("https://corona.lmao.ninja/countries/")
        .then(function (response) { $scope.countriesData = response.data || []; });
    });

  </script>
</body>

</html>
